---
title: "DATA 621 Business Analytics & Data Mining" 
subtitle: "Homework #1 - Moneyball"
author: "Kyle Gilde"
date: "2/18/2018"
output: 
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    toc: true
    toc_depth: 3
---


```{r knitr_options, echo=FALSE}
knitr::opts_chunk$set(
                      error = FALSE
                      ,message = FALSE
                      #,tidy = TRUE
                      ,cache = TRUE
                      )
```


```{r packages, echo=F, collapse=T} 
#required packages
packages <- c("prettydoc", "psych", "knitr", "tidyverse", "ggthemes", "corrplot") 

#see if we need to install any of them
installed_and_loaded <- function(pkg){
  #CODE SOURCE: https://gist.github.com/stevenworthington/3178163
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE, quietly = TRUE, warn.conflicts = FALSE)
}

#excute function and display the loaded packages
data.frame(installed_and_loaded(packages))
```

# 1. DATA EXPLORATION


```{r getdata}
train_raw <- read.csv("https://raw.githubusercontent.com/kylegilde/D621-Data-Mining/master/HW1%20Moneyball/moneyball-training-data.csv")

train_raw <- train_raw %>% select(-INDEX)

evalution_raw <- read.csv("https://raw.githubusercontent.com/kylegilde/D621-Data-Mining/master/HW1%20Moneyball/moneyball-evaluation-data.csv")

```

## Non-visual exploration

###About the data

From the prompt: "Each record represents a professional baseball team from the years 1871 to 2006 inclusive. Each record has the performance of the team for the given year, with all of the statistics adjusted to match the performance of a 162 game season."

###Data Inspection

Let's take a look at the data's non-statistical aspects.

```{r}

metadata <- function(df){
  #Takes a data frame & Checks NAs, class types, inspects the unique values
  df_len <- nrow(df)
  NA_ct = as.vector(rapply(df, function(x) sum(is.na(x))))

  #create dataframe  
  df_metadata <- data.frame(
    class_type = rapply(df, class),
    n_rows = rapply(df, length),
    complete_cases = sum(complete.cases(df)),
    NA_ct = NA_ct,
    NA_pct = NA_ct / df_len * 100,
    unique_value_ct = rapply(df, function(x) length(unique(x))),
    most_common_values_sample = rapply(df, function(x) str_replace(paste(names(sort(summary(as.factor(x)), decreasing=T))[1:5], collapse = '; '), "\\(Other\\); ", ""))
  )
  return(df_metadata)
}

kable(metadata(train_raw), digits = 1)

```

+ The data set contains all integers.

+ The data set has less than 10% complete cases. 

+ Six variables are missing values with TEAM_BATTING_HBP, TEAM_BASERUN_CS & TEAM_FIELDING_DP being the most sparse with 92%, 34% & 13% `NA`s, respectively. We will either have to drop the variables or impute the missing values.





##Statistical Summary

```{r stats}
metrics <- function(df){
  metrics_only <- df[, which(rapply(df, class) %in% c("numeric", "integer"))]
  df_metrics <- describe(metrics_only, quant = c(.25,.75))
  return(df_metrics)
}

kable(metrics(train_raw), digits = 1, format.args = list(big.mark = ',', scientific = F, drop0trailing = T))
```

From the summary stats listed above and the 3 distributions centered away from zero shown below, it seems unlikely that the `NA`s might be zero-values. Let's drop hit-by-pitches and caught-stealing, which are missing significant amounts of values, and try to impute the values for the other 4 variables.

```{r missing_var, warning=FALSE}
par(mfrow=c(2,2))
hist(train_raw$TEAM_BATTING_HBP)
hist(train_raw$TEAM_BASERUN_CS)
hist(train_raw$TEAM_FIELDING_DP)
# pltbase <- ggplot(data = train_raw)
# pltbase + geom_density(aes(x = TEAM_BATTING_HBP))
# pltbase + geom_density(aes(x = TEAM_BASERUN_CS))
# pltbase + geom_density(aes(x = TEAM_FIELDING_DP))
# pltbase + geom_density(aes(x = TEAM_BASERUN_SB))
# pltbase + geom_density(aes(x = TEAM_PITCHING_SO))
# pltbase + geom_density(aes(x = TEAM_BATTING_SO))

```


```{r}
#calculate some parameters to deal with the outliers
train_stacked <- na.omit(stack(train_raw))
bpstats <- boxplot(values ~ ind, data = train_stacked, plot = F)$stats
ylimits <- c(0, ceiling(max(bpstats) / 200)) * 200
ybreaks <- seq(ylimits[1], ylimits[2], by = 200)
outliers_not_shown <- paste(sum(train_stacked$values > max(ylimits)), "outlier(s) not displayed")

ggplot(data = train_stacked) + 
  geom_boxplot(aes(x = ind, y = values)) +
  labs(title = "Company Sizes in NY by Industry",
       caption = paste("Red dot = mean", outliers_not_shown, sep = "\n")) +
  scale_x_discrete(limits = rev(levels(train_stacked$ind))) +
  scale_y_continuous(breaks = ybreaks) +
  #stat_summary(fun.y=mean, geom="point", size=2, color = "red") +
  coord_flip(ylim = ylimits) +
  theme_fivethirtyeight()


```

```{r fig.width = 10, fig.height = 11}
cormatrix <- cor(drop_na(train_raw))
corrplot(cormatrix, method = "square", type = "upper")

cor_df <- data.frame(row=rownames(cormatrix)[row(cormatrix)],
                     col=colnames(cormatrix)[col(cormatrix)],
                     corr=c(cormatrix))

(cor_df <- 
  cor_df %>% 
  filter(row != col) %>% 
  arrange(-corr))

#https://stackoverflow.com/questions/28035001/transform-correlation-matrix-into-dataframe-with-records-for-each-row-column-pai
```



#2. DATA PREPARATION


#3. BUILD MODELS

#4. SELECT MODELS

